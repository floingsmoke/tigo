<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Mon profil Tigo">
    <title>Mon profil - Tigo</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/components.css">
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar" id="navbar">
        <div class="navbar-container">
            <a href="/" class="navbar-logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path
                        d="M19 17h2l.64-2.54c.24-.959.52-1.962-.01-2.481-.53-.52-1.57-.126-2.63-.189V9a3 3 0 0 0-3-3h-2.21a5 5 0 0 0-4.58 3H4a2 2 0 0 0-2 2v4h2" />
                    <circle cx="6.5" cy="17.5" r="2.5" />
                    <circle cx="16.5" cy="17.5" r="2.5" />
                </svg>
                Tigo
            </a>

            <div class="navbar-nav" id="navbar-nav">
                <a href="/" class="navbar-link">Accueil</a>
                <a href="/trips.html" class="navbar-link">Trajets</a>
                <a href="/map.html" class="navbar-link">Carte</a>
                <a href="/calendar.html" class="navbar-link">Calendrier</a>
            </div>

            <div class="navbar-actions">
                <div class="navbar-notifications hidden" id="navbar-notifications">
                    <button class="navbar-icon-btn" id="notifications-btn">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
                            <path d="M13.73 21a2 2 0 0 1-3.46 0" />
                        </svg>
                        <span class="notification-badge hidden" id="notification-count">0</span>
                    </button>
                    <div class="notification-dropdown" id="notification-dropdown"></div>
                </div>

                <a href="/messages.html" class="navbar-icon-btn hidden" id="messages-btn">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                    </svg>
                </a>

                <a href="/post-trip.html" class="btn btn-primary hidden" id="post-trip-btn">Poster</a>

                <div class="navbar-auth" id="navbar-auth">
                    <a href="/login.html" class="btn btn-ghost">Connexion</a>
                    <a href="/register.html" class="btn btn-primary">S'inscrire</a>
                </div>

                <a href="/profile.html" class="navbar-user hidden" id="navbar-user">
                    <img src="/assets/images/default-avatar.svg" alt="Profile" class="navbar-avatar" id="navbar-avatar">
                    <span class="navbar-username" id="navbar-username">Utilisateur</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="toast-container" id="toast-container"></div>

    <!-- Profile Page -->
    <main class="profile-page">
        <div class="profile-container">
            <!-- Profile Header -->
            <div class="profile-header">
                <div class="profile-avatar-container">
                    <img src="/assets/images/default-avatar.svg" alt="Photo de profil" class="profile-avatar"
                        id="profile-avatar">
                </div>
                <div class="profile-info">
                    <h2 id="profile-name">Nom d'utilisateur</h2>
                    <p id="profile-email">email@example.com</p>
                    <div class="profile-stats">
                        <div class="profile-stat">
                            <div class="profile-stat-value" id="trips-count">0</div>
                            <div class="profile-stat-label">Trajets publiés</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Content Grid -->
            <div class="profile-grid">
                <!-- Sidebar / Menu -->
                <div class="profile-sidebar">
                    <button class="profile-menu-btn active" data-target="my-trips">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path
                                d="M19 17h2l.64-2.54c.24-.959.52-1.962-.01-2.481-.53-.52-1.57-.126-2.63-.189V9a3 3 0 0 0-3-3h-2.21a5 5 0 0 0-4.58 3H4a2 2 0 0 0-2 2v4h2" />
                            <circle cx="6.5" cy="17.5" r="2.5" />
                            <circle cx="16.5" cy="17.5" r="2.5" />
                        </svg>
                        Mes trajets
                    </button>
                    <button class="profile-menu-btn" data-target="settings">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path
                                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                            </path>
                        </svg>
                        Paramètres
                    </button>
                    <button class="profile-menu-btn logout" onclick="logout()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                            <polyline points="16,17 21,12 16,7" />
                            <line x1="21" y1="12" x2="9" y2="12" />
                        </svg>
                        Déconnexion
                    </button>
                </div>

                <!-- Main Content -->
                <div class="profile-content">
                    <!-- My Trips Section -->
                    <div id="section-my-trips" class="profile-section-content active">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
                            <h3 class="profile-section-title" style="margin: 0; padding: 0; border: 0;">Mes trajets</h3>
                            <a href="/post-trip.html" class="btn btn-primary btn-sm">+ Nouveau trajet</a>
                        </div>
                        <div id="my-trips">
                            <div class="loading">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Section -->
                    <div id="section-settings" class="profile-section-content hidden">
                        <h3 class="profile-section-title">Paramètres du profil</h3>

                        <form id="profile-settings-form">
                            <!-- Avatar Upload -->
                            <div class="settings-group">
                                <h4 class="settings-subtitle">Photo de profil</h4>
                                <div class="settings-avatar-container">
                                    <img src="/assets/images/default-avatar.svg" alt="Photo de profil"
                                        class="settings-avatar" id="settings-avatar-preview">
                                    <div class="settings-avatar-actions">
                                        <label for="settings-avatar-input" class="btn btn-secondary btn-sm">
                                            Changer la photo
                                        </label>
                                        <input type="file" id="settings-avatar-input" accept="image/*"
                                            style="display: none;">
                                        <p class="form-hint">JPG, PNG ou GIF. Max 5Mo.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Personal Info -->
                            <div class="settings-group">
                                <h4 class="settings-subtitle">Informations personnelles</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Nom complet</label>
                                        <input type="text" class="form-input" id="settings-name" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Téléphone</label>
                                        <input type="tel" class="form-input" id="settings-phone">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-input" id="settings-email" required>
                                    <p class="form-hint">Un email de confirmation sera envoyé si vous changez votre
                                        adresse.</p>
                                </div>
                            </div>

                            <!-- Security -->
                            <div class="settings-group">
                                <h4 class="settings-subtitle">Sécurité</h4>
                                <div class="form-group">
                                    <label class="form-label">Nouveau mot de passe</label>
                                    <input type="password" class="form-input" id="settings-password"
                                        placeholder="Laisser vide pour ne pas changer">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Confirmer le nouveau mot de passe</label>
                                    <input type="password" class="form-input" id="settings-password-confirm"
                                        placeholder="Confirmer le nouveau mot de passe">
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary btn-lg"
                                style="width: 100%; margin-top: var(--spacing-md);">
                                Sauvegarder les modifications
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-bottom" style="border: none; padding-top: 0;">
                <p>© 2025 Tigo. Tous droits réservés.</p>
            </div>
        </div>
    </footer>

    <script src="/js/app.js"></script>
    <script src="/js/auth.js"></script>
    <script>
        let profilePageUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const isLoggedIn = await checkAuth();
                if (!isLoggedIn) {
                    window.location.href = '/login.html';
                    return;
                }

                await loadProfile();
                await loadMyTrips();
                setupTabs();
                setupAvatarUpload();
                setupSettingsForm();

            } catch (error) {
                console.error('Profile page init error:', error);
                showToast('Erreur de chargement', 'error');
            }
        });

        function setupTabs() {
            const buttons = document.querySelectorAll('.profile-menu-btn[data-target]');
            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Update buttons
                    document.querySelectorAll('.profile-menu-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    // Update sections
                    const targetId = `section-${btn.dataset.target}`;
                    document.querySelectorAll('.profile-section-content').forEach(s => {
                        if (s.id === targetId) {
                            s.classList.remove('hidden');
                            s.classList.add('active');
                        } else {
                            s.classList.add('hidden');
                            s.classList.remove('active');
                        }
                    });
                });
            });
        }

        async function loadProfile() {
            try {
                const response = await fetch('/api/auth/me', { credentials: 'include' });
                const data = await response.json();
                profilePageUser = data.user;

                // Header info
                document.getElementById('profile-name').textContent = profilePageUser.name;
                document.getElementById('profile-email').textContent = profilePageUser.email;

                if (profilePageUser.profile_photo) {
                    document.getElementById('profile-avatar').src = profilePageUser.profile_photo;
                    document.getElementById('settings-avatar-preview').src = profilePageUser.profile_photo;
                }

                // Settings form pre-fill
                document.getElementById('settings-name').value = profilePageUser.name;
                document.getElementById('settings-email').value = profilePageUser.email;
                document.getElementById('settings-phone').value = profilePageUser.phone || '';

            } catch (e) {
                console.error('Error loading profile:', e);
                throw e;
            }
        }

        function setupAvatarUpload() {
            const avatarInput = document.getElementById('settings-avatar-input');
            avatarInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // Update preview in settings
                        document.getElementById('settings-avatar-preview').src = e.target.result;
                        // Update header avatar too for immediate feedback
                        document.getElementById('profile-avatar').src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function setupSettingsForm() {
            const form = document.getElementById('profile-settings-form');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const password = document.getElementById('settings-password').value;
                const confirmPassword = document.getElementById('settings-password-confirm').value;

                if (password && password !== confirmPassword) {
                    showToast('Les mots de passe ne correspondent pas', 'error');
                    return;
                }

                const formData = new FormData();
                formData.append('name', document.getElementById('settings-name').value);
                formData.append('email', document.getElementById('settings-email').value);
                formData.append('phone', document.getElementById('settings-phone').value);

                if (password) {
                    formData.append('password', password);
                }

                const avatarInput = document.getElementById('settings-avatar-input');
                if (avatarInput.files[0]) {
                    formData.append('profile_photo', avatarInput.files[0]);
                }

                // Initial UI feedback
                const btn = form.querySelector('button[type="submit"]');
                const originalText = btn.textContent;
                btn.textContent = 'Sauvegarde en cours...';
                btn.disabled = true;

                try {
                    const response = await fetch('/api/auth/profile', {
                        method: 'PUT',
                        body: formData,
                        credentials: 'include'
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showToast('Profil mis à jour avec succès !', 'success');

                        // Use simulated email confirmation logic if email changed
                        if (data.emailChanged) {
                            showToast('Veuillez vérifier vos emails pour confirmer la nouvelle adresse.', 'info');
                        }

                        // Update local data
                        await loadProfile();

                        // Clear password fields
                        document.getElementById('settings-password').value = '';
                        document.getElementById('settings-password-confirm').value = '';

                        // Reset file input
                        avatarInput.value = '';

                    } else {
                        showToast(data.message || 'Erreur lors de la mise à jour', 'error');
                    }
                } catch (e) {
                    console.error('Save error:', e);
                    showToast('Erreur de connexion', 'error');
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            });
        }

        async function loadMyTrips() {
            const container = document.getElementById('my-trips');
            try {
                const response = await fetch('/api/trips/user/my-trips', { credentials: 'include' });
                const data = await response.json();

                const trips = data.trips || [];
                document.getElementById('trips-count').textContent = trips.length;

                if (trips.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: var(--spacing-lg); text-align: center;">
                            <p class="text-muted" style="margin-bottom: 1rem;">Vous n'avez pas encore publié de trajet.</p>
                            <a href="/post-trip.html" class="btn btn-primary">Poster mon premier trajet</a>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = trips.map(trip => `
                    <div class="trip-card" style="margin-bottom: var(--spacing-md);">
                        <div class="trip-card-header">
                            <div class="trip-route">
                                <div class="trip-city">
                                    <span class="trip-city-marker departure"></span>
                                    <span class="trip-city-name">${trip.departure_city}</span>
                                </div>
                                <svg class="trip-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                    <polyline points="12,5 19,12 12,19"/>
                                </svg>
                                <div class="trip-city">
                                    <span class="trip-city-marker arrival"></span>
                                    <span class="trip-city-name">${trip.arrival_city}</span>
                                </div>
                            </div>
                        </div>
                        <div class="trip-card-body">
                            <div class="trip-info">
                                <div class="trip-info-item">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                        <line x1="16" y1="2" x2="16" y2="6"/>
                                        <line x1="8" y1="2" x2="8" y2="6"/>
                                    </svg>
                                    ${formatDate(trip.date)}
                                </div>
                                <div class="trip-info-item">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"/>
                                        <polyline points="12,6 12,12 16,14"/>
                                    </svg>
                                    ${trip.time}
                                </div>
                            </div>
                            <a href="/trip-detail.html?id=${trip.id}" class="btn btn-primary btn-sm">Voir</a>
                        </div>
                    </div>
                `).join('');

            } catch (e) {
                console.error('Error loading trips:', e);
                container.innerHTML = '<p style="padding: 1rem; color: var(--error);">Erreur de chargement des trajets</p>';
            }
        }
    </script>
</body>

</html>